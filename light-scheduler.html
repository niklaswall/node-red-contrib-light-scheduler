<script type="text/javascript">
  RED.nodes.registerType('light-scheduler', {
    category: 'function',
    color:"#F8B1FF",
    defaults: {
      settings: {value: "", type: "light-scheduler-settings"},
      schedule: {value: '', type: 'light-scheduler-schedule'},
      topic: {value:""},
      name: {value:""},
      onPayload: {value:"ON", validate: RED.validators.typedInput("onPayloadType")},
      onPayloadType: {value:"str"},
      offPayload: {value:"OFF", validate: RED.validators.typedInput("offPayloadType")},
      offPayloadType: {value:"str"},
      sunShowElevationInStatus: {value: false},
      outputfreq: {value: "output.statechange.startup"}
    },
    inputs: 1,
    outputs: 1,
    icon: 'cal.png',
    paletteLabel: 'Light Scheduler',
    label: function(){
      return this.name?this.name:'Light Scheduler'
    },
    inputLabels: ['Control Input'],
    outputLabels: ['Schedule Output'],
    oneditprepare: function() {
      var node = this;

      var setup = function(node) {
        $("#node-input-outputfreq").val(node.outputfreq ? node.outputfreq : 'output.statechange.startup');        
      
        if(node.onPayloadType == null) {
          node.onPayloadType = "str";
        }
        $("#node-input-onPayloadType").val(node.onPayloadType);

        $("#node-input-onPayload").typedInput({
          default: 'str',
          typeField: $("#node-input-onPayloadType"),
          types:['str','num','bool','json']
        });

        if(node.offPayloadType == null) {
          node.offPayloadType = "str";
        }
        $("#node-input-offPayloadType").val(node.offPayloadType);

        $("#node-input-offPayload").typedInput({
          default: 'str',
          typeField: $("#node-input-offPayloadType"),
          types:['str','num','bool','json']
        });
      }
    },

  });
</script>
<script type="text/x-red" data-template-name="light-scheduler">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name"></input>
  </div>
  
  <div style="padding-top: 15px">
    <h5>Globals</h5>
    <div class="form-row">
      <label for="node-input-settings"><i class="fa fa-globe"></i> Location</label>
      <input type="text" id="node-input-settings"></input>
    </div>
    <div class="form-row">
      <label for="node-input-schedule"><i class="fa fa-globe"></i> Schedule</label>
      <input type="text" id="node-input-schedule"></input>
    </div>
  </div>


  <div style="padding-top: 15px">
    <h5>Output</h5>

    <div class="form-row">
      <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
      <input type="text" id="node-input-topic" placeholder="Topic"></input>
    </div>
    <div class="form-row">
      <label for="node-input-onPayload"><i class="fa fa-envelope"></i> On Payload</label>
      <input type="text" id="node-input-onPayload" placeholder="ON"></input>
      <input type="hidden" id="node-input-onPayloadType"></input>
    </div>
    <div class="form-row">
      <label for="node-input-offPayload"><i class="fa fa-envelope"></i> Off Payload</label>
      <input type="text" id="node-input-offPayload" placeholder="OFF"></input>
      <input type="hidden" id="node-input-offPayloadType"></input>
    </div>
    <div class="form-row">
      <label for="node-input-outputfreq"><i class="fa fa-play"></i> Output </label>
      <select id="node-input-outputfreq">
        <option value="output.statechange">when state changes</option>
        <option value="output.statechange.startup">when state changes + startup</option>
        <option value="output.minutely">minutely</option>
      </select>
    </div>
  </div>
  
  <div class="form-row">
      <label>&nbsp;</label>
      <input type="checkbox" id="node-input-sunShowElevationInStatus" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-input-sunShowElevationInStatus" style="width: 70%;">Show sun elevation in status.</label>
  </div>
   
</script>
<script type="text/x-red" data-help-name="light-scheduler">
  <p>A node to control light based on a schedule and the sun position.</p>
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">string</span></dt>
    <dd>
      <p>The <code>msg.payload</code> will be used to set the override-mode of the light scheduler.</p>
      <p>Valid overrides:
      <ul>
        <li>auto - Removes the override and act according to configuration.</li>
        <li>stop - Postpone all output.</li>
        <li>on / 1 - Forces output to ON state.</li>
        <li>off / 0 - Forces output to OFF state.</li>
        <li>light-only - Ignores the schedule and turns ON if it is considered dark.</li>
        <li>schedule-only - Ignores the light level and turns ON according to schedule.</li>
        <li>trigger - Force output according to the ongoing settings.</li>
      </ul>
      <i>Please Note:</i> The override is runtime only and will revert to auto during deploy / restart.
      </p>
    </dd>
  </dl>

  <h3>Output</h3>
  <dl class="message-properties">
    <dt>payload</dt>
    <dd>The payload will be set according to the settings and will output either the ON or OFF payload depending on the set parameters.</dd>
  </dl>

  The output setting can be either of:
  <ul>
    <li>"when state changes" - Will only output a <code>msg</code> when the state changes. The state is evaluated on a minutely basis, so it can take up to a minute after deploy of a new configu before the output it triggered.</li>
    <li>"when state changes + startup" - Will only output a <code>msg</code> when the state changes and directly after a deploy and a restart of node-red.</li>
    <li>"minutely" - Will only output a <code>msg</code> on a minutely basis even if the state have not changed.</li>
  </ul>

</script>
